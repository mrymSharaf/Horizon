{% extends "base.html" %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'styles/user/user-profile.css' %}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
{% endblock head %}

{% block body %}
<div class="profile-container">

    <div class="profile-header">
        <div class="profile-photo">
            {% if user.profile.profile_photo %}
                <img src="{{ user.profile.profile_photo.url }}" alt="profile photo">
            {% else %}
                <img src="https://res.cloudinary.com/dquu356xs/image/upload/v1757511943/no-pfp_sx5tta.webp" alt="Default Profile">
            {% endif %}
        </div>
        <div class="profile-info">
            <div class="username-row">
                <h1 class="username">{{user.username}}</h1>
                {% if request.user == user %}
                    <div class="profile-actions">
                        <a href="{% url 'user-update' user.pk%}"><i class="fa-solid fa-pencil"></i></a>
                        <a href="{% url 'user-delete' user.pk%}"><i class="fa-solid fa-trash"></i></a>
                    </div>
                {% endif %}
            </div>

            <div class="follow-section">
                {% if request.user != user %}
                <form method="post" action="{% url 'toggle-follow' user.pk %}" class="follow-form" id="follow-{{ user.pk }}" data-user="{{ user.pk }}">
                    {% csrf_token %}
                    <button type="submit" class="follow-btn">
                    {% if is_following %}
                        <span class="follow-text" data-user="{{ user.pk }}">Following</span>
                    {% else %}
                        <span class="follow-text" data-user="{{ user.pk }}">Follow</span>
                    {% endif %}
                    </button>
                </form>
                {% endif %}

                <div class="follow-info">
                    <span class="posts-count">{{ posts_count|default:"0" }}</span> posts |
                    <a href="{% url 'followers' user.pk %}"><span class="followers-count">{{ followers_count| default:"0" }}</span> followers</a> |
                    <a href="{% url 'following' user.pk %}"><span class="following-count">{{ following_count| default:"0" }}</span> following</a>
                </div>
            </div>

            <p class="bio">{{user.profile.bio}}</p>
        </div>
    </div>

    <div class="profile-posts">
        {% if visits %}
            {% for visit in visits %}
            <div class="post-card">
                <a href="{% url 'visit-details' visit.pk %}">
                    <img src="{{ visit.photo.url }}" alt="Visit photo">
                    <span class="hidden-text">View more</span>
                </a>
            </div>
            {% endfor %}
        {% else %}
            {% if request.user == user %}
                <div class="no-posts-container"> 
                    <p class="no-posts-text">No posts</p>
                    <a href="{% url 'visit-create' %}" class="new-post-btn">Create a Post</a>
                </div>
            {% endif %}
        {% endif %}
    </div>
</div>
{% endblock body %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('.follow-form').submit(function(e){
        e.preventDefault()

        const user_id = $(this).data('user') 
        const url = $(this).attr('action')

        $.ajax({
            type: 'POST',
            url: url,
            data: {
                'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                'user_id': user_id,
            },
            success: function(response) {
                if(response.followed) {
                    $(`.follow-text[data-user=${user_id}]`).text("Following")
                } else {
                    $(`.follow-text[data-user=${user_id}]`).text("Follow")
                }

                $('.followers-count').text(response.followers_count)
                $('.following-count').text(response.following_count)
            },
            error: function(response) {
                console.log('error', response)
            }
        })
    })
})
</script>
{% endblock scripts %}

